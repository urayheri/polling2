<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polling Video Terbaik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Transisi halus pada kartu */
        .video-card {
            transition: all 0.3s ease-in-out;
        }
        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .winner-glow {
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.7), 0 0 15px rgba(255, 215, 0, 0.5);
            border: 4px solid #FFD700;
        }

        /* Animasi Pulse untuk feedback LIKE */
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); opacity: 0.9; }
            100% { transform: scale(1); }
        }
        .like-pulse {
            animation: pulse-once 0.3s ease-out;
        }
        
        .heart-icon {
            transition: all 0.2s; /* Transisi warna dan ukuran ikon */
        }
        /* Custom disabled style for select */
        select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Polling Video Terbaik üèÜ</h1>
            <p class="text-xl text-gray-600">Pilih video favoritmu! Satu nama, email, & peran **terverifikasi** hanya dapat memberikan satu like.</p>
            <div id="user-info-display" class="mt-4 text-sm text-gray-500">
                </div>
            <div id="app-id-display" class="mt-1 text-xs text-gray-400">
                </div>
        </header>

        <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md transform transition-all scale-95">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Verifikasi Diri Anda (Login untuk Voting)</h2>
                <p class="mb-6 text-gray-600">Anda harus memilih peran (Siswa/Guru) dan memasukkan Email & Nama. Data ini memastikan 1 identitas hanya 1 suara.</p>
                <input type="text" id="voter-name" placeholder="Nama Lengkap" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                
                <select id="voter-role" onchange="handleRoleChange()" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">-- Pilih Peran Anda --</option>
                    <option value="Siswa">Siswa</option>
                    <option value="Guru">Guru</option>
                </select>

                <select id="voter-grade" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">-- Pilih Tingkat Kelas --</option>
                    <option value="X">Kelas X</option>
                    <option value="XI">Kelas XI</option>
                </select>

                <select id="voter-major" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                    <option value="">-- Pilih Jurusan --</option>
                    <option value="DTB">DTB</option>
                    <option value="TSM">TSM</option>
                    <option value="TKR">TKR</option>
                    <option value="APHP">APHP</option>
                    <option value="RPL">RPL</option>
                    <option value="DKV">DKV</option>
                    <option value="ML">ML</option>
                    <option value="HOTEL">HOTEL</option>
                    <option value="AKUNTANSI">AKUNTANSI</option>
                    <option value="TP">TP</option>
                    <option value="BD">BD</option>
                </select>

                <input type="email" id="voter-email" placeholder="Alamat Email (Wajib)" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button onclick="submitVoterInfo()" id="submit-voter-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:opacity-50">
                    Verifikasi dan Mulai Voting
                </button>
            </div>
        </div>
        
        <div id="message-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 pointer-events-none z-50"></div>


        <div id="video-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, getDocs, arrayUnion, arrayRemove, setLogLevel, 
            increment // <-- FIXED: Tambahkan increment untuk update counter yang aman
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // ====================================================================
        // KONFIGURASI FIREBASE ANDA (DIAMBIL DARI JAWABAN SEBELUMNYA)
        // ====================================================================
        const githubFirebaseConfig = {
             apiKey: "AIzaSyAuf_coM6BxA2k1zEIRYYLjbMsb3CuTYBM", 
             authDomain: "polling-a4ec5.firebaseapp.com", 
             projectId: "polling-a4ec5", 
             storageBucket: "polling-a4ec5.appspot.com", 
             messagingSenderId: "203299918012", 
             appId: "1:203299918012:web:a46e4820bd1e3618d740b9" 
        };
        
        // PENTING: Gunakan konfigurasi Canvas jika ada, atau gunakan konfigurasi GitHub yang sudah diisi
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(githubFirebaseConfig));
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Use Debug logging for development
        setLogLevel('Debug');

        // State variables
        let userId = null;
        let userData = null; // { name: '...', email: '...', voterRole: '...', voterClass: '...' }
        
        // ====================================================================
        // Fungsi utilitas untuk memproses link video dan thumbnail
        // ====================================================================

        /**
         * Mengestrak ID YouTube dari berbagai format URL dan mengembalikannya dalam format embed.
         * @param {string} urlOrId - URL YouTube, link embed, atau ID video.
         * @returns {string} Link embed YouTube yang valid.
         */
        function getYoutubeEmbedUrl(urlOrId) {
            let id = urlOrId;
            const embedPrefix = "https://www.youtube.com/embed/";

            // Cek jika ini URL tontonan standar
            const watchMatch = urlOrId.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/))([^&?]+)/i);
            if (watchMatch && watchMatch[1]) {
                id = watchMatch[1];
            }
            
            // Cek jika ini sudah link embed
            if (urlOrId.startsWith(embedPrefix)) {
                return urlOrId;
            }
            
            return `${embedPrefix}${id}`;
        }
        
        /**
         * Mendapatkan URL thumbnail kualitas tinggi dari ID video YouTube.
         * @param {string} urlOrId - URL YouTube, link embed, atau ID video.
         * @returns {string} Link thumbnail.
         */
        function getYoutubeThumbnailUrl(urlOrId) {
            let id = urlOrId;
            const watchMatch = urlOrId.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/|v\/))([^&?]+)/i);
            if (watchMatch && watchMatch[1]) {
                id = watchMatch[1];
            }
            return `https://img.youtube.com/vi/${id}/maxresdefault.jpg`;
        }
        
        // ====================================================================
        // START EDIT DI SINI UNTUK MEMASUKKAN DATA VIDEO BARU ANDA
        // Gunakan ID video YouTube atau link penuh. Kode akan mengkonversinya.
        // ====================================================================
        
        let videos = [
            { 
                id: 'video_satu', 
                title: 'Perjalanan ke Himalaya (Contoh Video 1)', 
                creator: 'Tim Petualang', 
                likes: 0, 
                videoId: 'g8J18uB69sA' // Cukup masukkan ID video
            },
            { 
                id: 'video_dua', 
                title: 'Tutorial Masak Rendang Klasik (Contoh Video 2)', 
                creator: 'Chef Nusantara', 
                likes: 0, 
                videoId: '2u3sYjS7T8U'
            },
            { 
                id: 'video_tiga', 
                title: 'Konser Musik Jazz Malam Hari (Contoh Video 3)', 
                creator: 'Band Senja', 
                likes: 0, 
                videoId: '5qap5aO4i9A'
            },
            // Tambahkan video baru di sini, gunakan videoId: 'ID_VIDEO_YOUTUBE'
        ];
        
        // Tambahkan properti url dan thumbnail secara dinamis
        videos = videos.map(v => ({
            ...v,
            url: getYoutubeEmbedUrl(v.videoId),
            thumbnail: getYoutubeThumbnailUrl(v.videoId)
        }));
        
        // ====================================================================
        // END EDIT DI SINI. JANGAN UBAH KODE DI BAWAH INI.
        // ====================================================================

        let userVote = null; // Stores the video ID the user has voted for

        // DOM elements
        const authModal = document.getElementById('auth-modal');
        const messageBox = document.getElementById('message-box');
        const videoListContainer = document.getElementById('video-list-container');
        const userInfoDisplay = document.getElementById('user-info-display');
        const appIdDisplay = document.getElementById('app-id-display');

        // Konstanta untuk Exponential Backoff
        const MAX_RETRIES = 3;
        const INITIAL_BACKOFF_MS = 1000;

        // --- Utility Functions ---

        /**
         * Fungsi penundaan berbasis Promise.
         * @param {number} ms - Milidetik untuk menunda.
         */
        const delay = ms => new Promise(res => setTimeout(res, ms));


        /**
         * Menampilkan pesan notifikasi sementara.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {string} type - Tipe pesan ('success', 'error', 'info').
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('opacity-0', 'pointer-events-none', 'bg-red-500', 'bg-green-500', 'bg-blue-500');

            if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }

            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0', 'pointer-events-none');
            }, 3000);
        }

        /**
         * Mengubah data video menjadi HTML card.
         * @param {Object} video - Objek data video.
         * @param {string|null} winnerId - ID video pemenang saat ini.
         * @param {string|null} userVoteId - ID video yang telah disukai pengguna.
         * @returns {string} HTML string.
         */
        function createVideoCard(video, winnerId, userVoteId) {
            const isWinner = video.id === winnerId;
            const isVoted = video.id === userVoteId;
            const buttonColor = isVoted ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-blue-600 hover:bg-blue-700';
            const buttonText = isVoted ? 'SUDAH DI-LIKE' : 'LIKE VIDEO INI';
            const winnerClass = isWinner ? 'winner-glow border-blue-500' : 'border-gray-200';
            const disabledAttr = isVoted ? 'disabled' : '';
            // Warna ikon hati: merah jika sudah divoting, abu-abu jika belum
            const heartColorClass = isVoted ? 'text-red-600' : 'text-gray-400';

            return `
                <div id="card-${video.id}" class="video-card bg-white rounded-xl shadow-lg p-5 border-4 ${winnerClass} transition duration-300">
                    <iframe 
                        class="w-full aspect-video rounded-lg mb-4" 
                        src="${video.url}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        onerror="this.src='${video.thumbnail}'"
                    ></iframe>
                    
                    <div class="flex items-start justify-between">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">${video.title}</h2>
                            <p class="text-sm text-gray-500 mb-4">Oleh: ${video.creator}</p>
                        </div>
                        ${isWinner ? '<span class="text-3xl" title="Pemenang Sementara">üëë</span>' : ''}
                    </div>

                    <div class="flex items-center justify-between mt-4 border-t pt-4">
                        <div id="like-counter-${video.id}" class="text-2xl font-extrabold text-gray-700 flex items-center">
                            <svg id="heart-${video.id}" class="w-8 h-8 mr-2 heart-icon ${heartColorClass}" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            <span id="likes-${video.id}" class="text-red-600">${video.likes}</span> Likes
                        </div>
                        <button onclick="handleLike('${video.id}')" 
                                id="btn-${video.id}"
                                ${disabledAttr}
                                class="py-2 px-4 text-white font-semibold rounded-lg shadow-md transition duration-150 ${buttonColor} disabled:opacity-50 disabled:cursor-not-allowed">
                            ${buttonText}
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Render ulang daftar video
         * @param {Array<Object>} currentVideos - Daftar video terbaru.
         * @param {string|null} userVoteId - ID video yang telah disukai pengguna.
         */
        function renderVideos(currentVideos, userVoteId) {
            // Tentukan pemenang (video dengan likes terbanyak)
            const winner = currentVideos.reduce((prev, current) => {
                return (prev.likes > current.likes) ? prev : current;
            }, { likes: -1, id: null });
            const winnerId = winner.id;

            videoListContainer.innerHTML = currentVideos.map(video => 
                createVideoCard(video, winnerId, userVoteId)
            ).join('');
        }

        // --- Firebase/Auth Functions ---

        /**
         * Menampilkan atau menyembunyikan modal autentikasi
         * @param {boolean} show - True untuk menampilkan, false untuk menyembunyikan.
         */
        function toggleAuthModal(show) {
            if (show) {
                authModal.classList.remove('opacity-0', 'pointer-events-none');
                authModal.querySelector('.max-w-md').classList.remove('scale-95');
                authModal.querySelector('.max-w-md').classList.add('scale-100');
            } else {
                authModal.classList.add('opacity-0', 'pointer-events-none');
                authModal.querySelector('.max-w-md').classList.remove('scale-100');
                authModal.querySelector('.max-w-md').classList.add('scale-95');
            }
        }
        
        /**
         * Mengubah status disabled pada dropdown kelas/jurusan berdasarkan peran (role).
         */
        window.handleRoleChange = function() {
            const role = document.getElementById('voter-role').value;
            const gradeSelect = document.getElementById('voter-grade');
            const majorSelect = document.getElementById('voter-major');

            const isDisabled = role !== 'Siswa';
            
            gradeSelect.disabled = isDisabled;
            majorSelect.disabled = isDisabled;

            // Clear values if disabled
            if (isDisabled) {
                gradeSelect.value = "";
                majorSelect.value = "";
            }
        };


        /**
         * Mendapatkan atau membuat data pengguna (nama, peran, kelas, & email) di Firestore.
         */
        async function fetchOrCreateUserData() {
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'voters', userId);
            
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        userData = userDocSnap.data();
                        userVote = userData.votedFor || null;
                        userInfoDisplay.innerHTML = `Anda masuk sebagai: <span class="font-semibold text-green-600">${userData.name} (${userData.voterRole} ${userData.voterClass || ''})</span>`;
                        showMessage(`Selamat datang kembali, ${userData.name} (${userData.voterRole})! Anda sudah terverifikasi.`, 'success');
                        toggleAuthModal(false);
                    } else {
                        // Jika data belum ada, kita perlu meminta verifikasi
                        userInfoDisplay.innerHTML = `Anda masuk (Sesi ID): <span class="font-semibold text-blue-600">${userId.substring(0, 8)}...</span>. <span class="text-red-500 font-bold">Lengkapi Verifikasi Diri untuk Voting.</span>`;
                        toggleAuthModal(true);
                        // Atur status awal dropdown saat modal ditampilkan
                        handleRoleChange(); 
                        return; // Hentikan proses, tunggu user submit di modal
                    }
                    // Jika berhasil, keluar dari loop retry
                    break;
                } catch (error) {
                    console.error(`Percobaan ${i + 1} gagal mengambil data pengguna:`, error);
                    if (i === MAX_RETRIES - 1) {
                        showMessage('Gagal memuat data pengguna setelah beberapa percobaan. Silakan coba lagi.', 'error');
                        return;
                    }
                    const backoffTime = INITIAL_BACKOFF_MS * Math.pow(2, i);
                    await delay(backoffTime);
                }
            }
            
            // Setelah data pengguna dimuat/dibuat, mulai mendengarkan perubahan video
            setupRealtimeListener();
        }

        /**
         * Dipanggil saat pengguna memasukkan Nama, Peran, Kelas, Jurusan, dan Email.
         */
        window.submitVoterInfo = async function() {
            const submitBtn = document.getElementById('submit-voter-btn');
            
            const nameInput = document.getElementById('voter-name').value.trim();
            const roleInput = document.getElementById('voter-role').value.trim(); // Peran: Siswa/Guru
            const gradeInput = document.getElementById('voter-grade').value.trim();
            const majorInput = document.getElementById('voter-major').value.trim();
            const emailInput = document.getElementById('voter-email').value.trim();
            
            if (!nameInput || !emailInput || roleInput === "") { 
                showMessage('Nama, Email, dan Peran tidak boleh kosong.', 'error');
                return;
            }

            // Validasi Khusus untuk Siswa
            if (roleInput === 'Siswa' && (gradeInput === "" || majorInput === "")) {
                showMessage('Sebagai Siswa, Tingkat Kelas dan Jurusan wajib dipilih.', 'error');
                return;
            }
            
            if (!emailInput.includes('@') || !emailInput.includes('.')) {
                showMessage('Format email tidak valid. Harap masukkan email yang benar.', 'error');
                return;
            }
            
            // Tentukan Class/ID Kelompok untuk unikness
            let classIdentifier;
            if (roleInput === 'Siswa') {
                // Siswa menggunakan kombinasi Kelas-Jurusan: Contoh X-RPL
                classIdentifier = `${gradeInput}-${majorInput}`;
            } else {
                // Guru menggunakan peran sebagai identifier kelas: Contoh Guru
                classIdentifier = roleInput; 
            }
            
            // Hash untuk pencarian cepat dan validasi unik: Nama | Email | ClassIdentifier
            const nameEmailClassHash = nameInput.toLowerCase() + '|' + emailInput.toLowerCase() + '|' + classIdentifier.toLowerCase();

            // Cek apakah kombinasi ini sudah terdaftar di Firestore
            const votersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'voters');
            
            // Query untuk mencari pengguna dengan hash kombinasi yang sama
            const q = query(votersCollectionRef, 
                where('name_email_hash', '==', nameEmailClassHash)
            );
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Memproses Verifikasi...';
            
            try {
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        const querySnapshot = await getDocs(q);
                        let existingUser = null;

                        querySnapshot.forEach(doc => {
                            if (doc.id !== userId) {
                                existingUser = doc.data();
                            }
                        });

                        if (existingUser) {
                            showMessage('Identitas (Nama, Email, Peran/Kelas) ini sudah terdaftar. Silakan gunakan kombinasi yang berbeda atau refresh halaman.', 'error');
                            return;
                        }

                        // Jika unik, simpan data pengguna baru di Firestore
                        const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'voters', userId);
                        userData = {
                            name: nameInput,
                            email: emailInput,
                            voterRole: roleInput,
                            voterClass: classIdentifier, // X-RPL atau Guru
                            voterGrade: roleInput === 'Siswa' ? gradeInput : null,
                            voterMajor: roleInput === 'Siswa' ? majorInput : null,
                            votedFor: null,
                            // Hash untuk pencarian cepat dan validasi unik (Kunci Login)
                            name_email_hash: nameEmailClassHash 
                        };
                        
                        await setDoc(userDocRef, userData);

                        userInfoDisplay.innerHTML = `Anda masuk sebagai: <span class="font-semibold text-green-600">${userData.name} (${userData.voterRole} ${userData.voterClass || ''})</span>`;
                        showMessage('Verifikasi berhasil! Silakan berikan like Anda.', 'success');
                        toggleAuthModal(false);
                        
                        // Mulai mendengarkan perubahan video setelah autentikasi
                        setupRealtimeListener();
                        
                        // Jika berhasil, keluar dari loop retry
                        break;

                    } catch (error) {
                        console.error(`Percobaan ${i + 1} gagal submit info voter:`, error);
                        if (i === MAX_RETRIES - 1) {
                            throw error; // Lempar error jika semua percobaan gagal
                        }
                        const backoffTime = INITIAL_BACKOFF_MS * Math.pow(2, i);
                        await delay(backoffTime);
                    }
                }
            } catch (error) {
                console.error("Fatal Error submitting voter info:", error);
                showMessage('Gagal menyimpan data voter setelah beberapa percobaan. Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Verifikasi dan Mulai Voting';
            }
        };
        
        /**
         * Proses like/unlike video.
         * @param {string} videoId - ID video yang di-like.
         */
        window.handleLike = async function(videoId) {
            if (!userId || !userData) {
                showMessage('Anda harus memverifikasi Identitas (Peran, Nama, Email) Anda terlebih dahulu.', 'error');
                toggleAuthModal(true);
                return;
            }
            if (userVote) {
                showMessage('Anda sudah memberikan suara untuk video lain. 1 pengguna hanya 1 like.', 'error');
                return;
            }

            // 1. Update Dokumen Video (Tambah Like) - MENGGUNAKAN INCREMENT
            const videoRef = doc(db, 'artifacts', appId, 'public', 'data', 'videos', videoId);
            try {
                // Menggunakan increment(1) untuk memastikan atomic update di server
                await updateDoc(videoRef, {
                    likes: increment(1) 
                });
            } catch (error) {
                console.error("Error incrementing video like:", error);
                showMessage('Gagal menambahkan like pada video.', 'error');
                return;
            }

            // 2. Update Dokumen Voter (Catat Suara)
            const voterRef = doc(db, 'artifacts', appId, 'public', 'data', 'voters', userId);
            try {
                await updateDoc(voterRef, {
                    votedFor: videoId
                });
                userVote = videoId; // Update state lokal

                // --- ANIMASI LIKE ---
                const heartElement = document.getElementById(`heart-${videoId}`);
                
                if (heartElement) {
                    // Beri warna merah dan picu animasi pulse
                    heartElement.classList.remove('text-gray-400');
                    heartElement.classList.add('text-red-600', 'like-pulse');
                    setTimeout(() => {
                        heartElement.classList.remove('like-pulse');
                    }, 300);
                }
                
                // Render ulang untuk menonaktifkan semua tombol vote
                renderVideos(videos, userVote); 

                showMessage('Like berhasil direkam! Terima kasih atas partisipasi Anda.', 'success');
            } catch (error) {
                console.error("Error updating voter data:", error);
                showMessage('Gagal mencatat suara Anda. Silakan coba lagi.', 'error');
            }
        };

        /**
         * Sinkronisasi Video Dummy ke Firestore jika belum ada.
         */
        async function initializeVideos() {
            const videoCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
            for (const video of videos) {
                const videoDocRef = doc(videoCollectionRef, video.id);
                try {
                    const docSnap = await getDoc(videoDocRef);
                    if (!docSnap.exists()) {
                        // Hanya set data jika belum ada, agar likes yang sudah ada tidak tertimpa
                        await setDoc(videoDocRef, { 
                            id: video.id,
                            title: video.title,
                            creator: video.creator,
                            url: video.url,
                            thumbnail: video.thumbnail,
                            likes: video.likes // 0
                        });
                        console.log(`Video ${video.id} berhasil diinisialisasi.`);
                    }
                } catch (error) {
                    console.error(`Gagal inisialisasi video ${video.id}:`, error);
                }
            }
        }

        /**
         * Menyiapkan listener real-time untuk data video.
         */
        function setupRealtimeListener() {
            const videoCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'videos');
            
            // Query untuk mendapatkan semua video
            const q = query(videoCollectionRef);

            onSnapshot(q, (snapshot) => {
                const updatedVideos = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    updatedVideos.push(data);
                });
                
                // Urutkan berdasarkan likes (tertinggi di atas)
                updatedVideos.sort((a, b) => b.likes - a.likes);
                videos = updatedVideos; // Update state global videos
                
                renderVideos(videos, userVote);
            }, (error) => {
                console.error("Error listening to video updates:", error);
                showMessage('Gagal memuat data polling secara real-time.', 'error');
            });
        }


        // --- Initialization and Auth Flow ---

        /**
         * Proses utama inisialisasi aplikasi.
         */
        async function initApp() {
            appIdDisplay.textContent = `App ID: ${appId}`;
            
            // 1. Autentikasi Perangkat/Sesi
            const authenticate = async () => {
                try {
                    if (initialAuthToken) {
                        // Jika ada token dari lingkungan Canvas, gunakan itu.
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Jika di luar Canvas (GitHub Pages), gunakan Anonymous Sign-in.
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Authentication failed:", error);
                    showMessage('Gagal autentikasi Firebase. Cek koneksi Anda dan pastikan konfigurasi sudah benar.', 'error');
                    return false; // Gagal autentikasi
                }
                return true; // Berhasil autentikasi
            };
            
            const isAuthenticated = await authenticate();

            // 2. Listener Auth State (Hanya jika Autentikasi berhasil)
            if (isAuthenticated) {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Inisialisasi video
                        await initializeVideos();
                        
                        // Lanjutkan ke pengambilan data voter
                        await fetchOrCreateUserData();
                        
                    } else {
                        userId = null;
                        userData = null;
                        userVote = null;
                        userInfoDisplay.textContent = 'Menunggu autentikasi...';
                    }
                });
            }
            
            // Render initial view (sebelum data dimuat)
            renderVideos(videos, userVote);
        }

        // Start the application
        window.onload = initApp;
    </script>
</body>

</html>
